(function() {
  'use strict';
  angular.module('somsri.payroll.report', [
  ])
  .controller('reportCtrl', ['$filter', '$rootScope', 'reportService', function($filter, $rootScope, reportService) {
    $rootScope.menu = "Report"
    
    var ctrl = this
    ctrl.total = 0
    ctrl.employees = []
    ctrl.months = []
    ctrl.currentMonth = ""

    ctrl.getNetSalary = function(employee) {
      return employee.salary - employee.extra_fee + employee.extra_pay;
    }

    function getTotalSalary(employees)  {
      var totalSalary = 0
      var totalExtraFee = 0
      var totalExtraPay = 0

      employees.forEach(function(employee) {
        totalSalary += employee.salary
        totalExtraFee += employee.extra_fee
        totalExtraPay += employee.extra_pay
      })

      return {
        salary: totalSalary,
        extraFee: totalExtraFee,
        extraPay: totalExtraPay,
        netSalary: totalSalary - totalExtraFee + totalExtraPay
      }
    }

    ctrl.switchMonth = function(month) {
      reportService.getPayroll(month.year, month.month).then(function(resp) {
        ctrl.employees = resp.data
        ctrl.total = getTotalSalary(ctrl.employees);
        ctrl.currentMonth = month
      });
    }

    reportService.getMonths().then(function(resp) {
      if (resp.data.length > 0) {
        ctrl.months = resp.data
        var current = ctrl.months[0]

        reportService.getPayroll(current.year, current.month).then(function(resp) {
          ctrl.employees = resp.data
          ctrl.total = getTotalSalary(ctrl.employees);
          getTotalSalary(ctrl.employees)
          ctrl.currentMonth = $filter('get_month_name')(ctrl.months[0])
        });
      }
    });
  }]);
})();
