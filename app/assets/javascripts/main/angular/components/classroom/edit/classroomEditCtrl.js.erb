(function() {
  'use strict';
  angular.module('somsri.main.classroom_edit', [
    ])
  .controller('classroomEditCtrl', ['$rootScope','classroomEditService','$scope', '$uibModal', '$state', function($rootScope, service, $scope, $uibModal, $state) {
    $rootScope.menu = "ตั้งค่า"
    var ctrl = this
    ctrl.classroomId = $state.params.id
    $rootScope.loadAndAuthorizeResource("school", function(){

      function imgFormatter(imgUrl) {
        if (imgUrl) {
          return '<div class="img-bg circle fix-img img-34x34" style="background: url('+ imgUrl +')"></div>';
        }
        return '<div class="img-bg bg-light-gray circle fix-img img-34x34"><i class="fa fa-user icon-default-img" aria-hidden="true"></i></div>'
      }

      function nameFormatter(name, url) {
        if(name){
          return '<a href="' + url + '" target="_blank" >' + name + '</a>';
        }else{
          return '<a href="' + url + '" target="_blank" >-</a>';
        }
      }

      var angularCtrlStr = "angular.element(document.getElementById('angularCtrl')).scope().edit"

      function formattingTeacherData(data) {
        var result = []
        if(data){
          data.forEach(function(teacher) {
            var onClick = angularCtrlStr + '.removeMember(' + teacher.id + ')'
            result.push({
              id: teacher.id,
              img: imgFormatter(teacher.img),
              name: nameFormatter(teacher.name, '/somsri_payroll#/employees/' + teacher.id),
              unselect: '<i class="fa fa-times cursor-pointer color-red" aria-hidden="true" onclick="' + onClick + '"></i>'
            })
          });
        }
        return result
      }

      function getCurrentTeacherIds(){
        var teacherIds = []
        $('#teacher-list').bootstrapTable('getData').forEach(function(teacher) {
          teacherIds.push(teacher.id)
        })
        return teacherIds
      }

      var currentTeacher = 0

      var tableColumnSetting = [
        { field: 'img', class:'font1_2em', title: "ชื่อ - นามสกุล", width: "10%"},
        { field: 'name', class:"center-vertical-padding font1_2em", width: "80%"},
        { field: 'unselect', class: "center-vertical-padding text-right font1_2em", width: "10%"}
      ]

      service.getClassroom(ctrl.classroomId).then(function(resp) {
        ctrl.classroom = resp.data
      });

      service.getTeachers(ctrl.classroomId).then(function(resp) {
        ctrl.teachers = formattingTeacherData(resp.data)
        ctrl.teachersAmount = ctrl.teachers.length
        $('#teacher-list').bootstrapTable({
          columns: tableColumnSetting,
          data: ctrl.teachers
        })
      });

      service.getStudents(ctrl.classroomId).then(function(resp) {
        ctrl.students = []
        resp.data.forEach(function(student) {
          ctrl.students.push({
            img: imgFormatter(student.img),
            name: nameFormatter(student.name, '/students/' + student.id + '/edit#/'),
            unselect: '<a class="color-red" href="/classroom/' + ctrl.classroomId + '/unselect?student_id=' + student.id + '"><i class="fa fa-times" aria-hidden="true"></i></a>'
          })
        });
        ctrl.studentsAmount = ctrl.students.length
        $('#student-list').bootstrapTable({
          columns: tableColumnSetting,
          data: ctrl.students
        })
      });

      ctrl.removeMember = function(id){
        var teachers = []
        $('#teacher-list').bootstrapTable('getData').forEach(function(teacher) {
          if(teacher.id != id){ teachers.push(teacher) }
        })
        $('#teacher-list').bootstrapTable('load', teachers)
        ctrl.teachersAmount -= 1
        $scope.$apply()
      }

      ctrl.selectTeacher = function(){
        $uibModal.open({
          animation: true,
          backdrop: 'static',
          keyboard: false,
          scope: $scope,
          templateUrl: "<%= asset_path('main/angular/components/modal/selectMember/selectMemberModalView.html') %>",
          controller: 'selectMemberModalCtrl as selectMember',
          size: 'md',
          resolve: {
            resources: ['$ocLazyLoad', 'ASSETS', function($ocLazyLoad, ASSETS) {
              return $ocLazyLoad.load([
                ASSETS.somsri.main.select_member_modal
              ]);
            }],
            options: function() {
              return {
                currentMemberIds: getCurrentTeacherIds(),
                classroomId: ctrl.classroomId
              }
            }
          }
        }).result.then(function (selectedTeacher) {
          var addingTeachers = formattingTeacherData(selectedTeacher)
          ctrl.teachersAmount += addingTeachers.length
          $('#teacher-list').bootstrapTable('append', addingTeachers)
        })
      }
    });
  }]);
})();
