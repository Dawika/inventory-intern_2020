(function() {
  'use strict';
  angular.module('somsri.main.setting', [])
    .controller('settingCtrl', ['$rootScope', 'settingService', '$scope', '$uibModal', function($rootScope, service, $scope, $uibModal) {
      $rootScope.menu = "ตั้งค่า"
      var ctrl = this
      $rootScope.loadAndAuthorizeResource("setting", function() {
        service.getSetting().then(function(resp) {
          ctrl.datas = resp.data;
          ctrl.datas.password = "password";
          if (ctrl.datas.school.auto_subscribe) {
            ctrl.button_auto_subscribe = 'btn btn-custom btn-red float-right size'
            ctrl.subscription = 'Cancel Subscribe'
          } else {
            ctrl.button_auto_subscribe = 'btn btn-custom btn-light-green float-right size'
            ctrl.subscription = 'Auto Subscribe'
          }
        });

        $rootScope.loadAndAuthorizeResource("school", function() {
          ctrl.canUpdateSchool = true;
        }, function() {});

        ctrl.submit = function(params) {
          service.saveSetting(params).then(function(resp) {
            opensuccessModal('บันทึกข้อมูลสำเร็จ');
          });
        }

        ctrl.auto_subscribe = function(value) {
          if (value) {
            ctrl.button_auto_subscribe = 'btn btn-custom btn-light-green float-right size'
            ctrl.subscription = 'Auto Subscribe'
            value = false
          } else {
            ctrl.button_auto_subscribe = 'btn btn-custom btn-red float-right size'
            ctrl.subscription = 'Cancel Subscribe'
            value = true
          }
          service.subscription(value).then(function(resp) {
            ctrl.datas.school.auto_subscribe = resp.data
            opensuccessModal('บันทึกข้อมูลสำเร็จ');
          })

        }

        $scope.fileChange = function(event, img_logo) {
          var logo = event.target.files[0]
          ctrl.datas.school.logo = logo;
          var logo_url = URL.createObjectURL(logo);
          $('#' + img_logo).attr('src', logo_url);
        }

        function opensuccessModal(message, success, dismiss) {
          $scope.message = message;
          $uibModal.open({
            animation: true,
            backdrop: 'static',
            keyboard: false,
            scope: $scope,
            templateUrl: "<%= asset_path('main/angular/components/modal/success/successModalView.html') %>",
            controller: 'successModalCtrl as success',
            size: 'md',
            resolve: {
              resources: ['$ocLazyLoad', 'ASSETS', function($ocLazyLoad, ASSETS) {
                return $ocLazyLoad.load([
                  ASSETS.somsri.main.success_modal
                ]);
              }]
            }
          }).result.then(function(isConfirm) {
            if (isConfirm) {
              if (success) { success() }
            } else {
              if (dismiss) { dismiss() }
            }
          });
        }

        ctrl.changePassword = function() {
          $uibModal.open({
            animation: true,
            backdrop: 'static',
            keyboard: false,
            scope: $scope,
            templateUrl: "<%= asset_path('main/angular/components/modal/password/passwordModalView.html') %>",
            controller: 'passwordModalCtrl as password',
            size: 'md',
            resolve: {
              resources: ['$ocLazyLoad', 'ASSETS', function($ocLazyLoad, ASSETS) {
                return $ocLazyLoad.load([
                  ASSETS.somsri.main.password_modal
                ]);
              }]
            }
          }).result.then(function(isSuccess) {
            if (isSuccess) {
              $rootScope.openRoot();
            }
          });
        }

      });
    }]);
})();