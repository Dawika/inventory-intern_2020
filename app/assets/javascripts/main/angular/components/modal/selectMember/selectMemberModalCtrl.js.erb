(function() {
  'use strict';
  angular.module('somsri.main.select_member_modal', [
    ])
  .controller('selectMemberModalCtrl', ['$uibModalInstance', '$uibModal', '$state', '$log', 'selectMemberModalService', 'options', function($uibModalInstance, $uibModal, $state, $log, service, options) {
    var ctrl = this;
    var currentMemberIds = options.currentMemberIds
    var classroomId = options.classroomId
    var tableColumnSetting = [
      { field: 'check-box', title: "เลือกทั้งหมด", checkbox: true },
      { field: 'img', class:'font1_2em' },
      { field: 'name', class:"center-vertical-padding font1_2em"}
    ]

    var angularCheckBox = "angular.element(document.getElementById('angularCtrl')).scope().$root.onCheckBoxChange()"

    function imgFormatter(imgUrl) {
      if (imgUrl) {
        return '<div class="img-bg circle fix-img img-34x34" style="background: url('+ imgUrl +')"></div>';
      }
      return '<div class="img-bg bg-light-gray circle fix-img img-34x34"><i class="fa fa-user icon-default-img" aria-hidden="true"></i></div>'
    }

    function nameFormatter(name, url) {
      if(name){
        return '<a href="' + url + '" target="_blank">' + name + '</a>';
      }else{
        return '<a href="' + url + '" target="_blank">-</a>';
      }
    }

    function formattingMemberData(data) {
      var result = []
      if(data){
        data.forEach(function(member) {
          var onClick = angularCheckBox + '.removeMember(' + member.id + ')'
          result.push({
            id: member.id,
            img: imgFormatter(member.img),
            name: nameFormatter(member.name, '/somsri_payroll#/employees/' + member.id)
          })
        });
      }
      return result
    }

    ctrl.selectedNumber = 0
    ctrl.teachersRawData = []
    ctrl.membersAmount = 0

    service.getTeacherNotAssignClass(classroomId, currentMemberIds).then(function(resp) {
      ctrl.teachersRawData = resp.data
      ctrl.teachers = formattingMemberData(resp.data)
      ctrl.teachersAmount = ctrl.teachers.length
      $('#member-select-list').bootstrapTable({
        selectItemName: "teacherId",
        search: true,
        toolbar: '.bt-toolbar',
        toolbarAlign: 'right',
        searchAlign: 'left',
        clickToSelect: true,
        columns: tableColumnSetting,
        data: ctrl.teachers
      })
    });

    ctrl.submit = function(){
      var result = []
      var selecteds = $('#member-select-list').bootstrapTable('getSelections')
      ctrl.teachersRawData.forEach(function(teacher) {
        var selectedIds = selecteds.map(function(selected) {
           return selected.id
        })
        if($.inArray(teacher.id, selectedIds) != -1){
          result.push(teacher)
        }
      })
      $uibModalInstance.close(result)
    }

    ctrl.cancel = function () {
      $uibModalInstance.close()
    }

    ctrl.createTeacher = function(){
      $uibModal.open({
        animation: true,
        backdrop: 'static',
        keyboard: false,
        templateUrl: "<%= asset_path('main/angular/components/modal/createMember/createMemberModalView.html') %>",
        controller: 'createMemberModalCtrl as create',
        size: 'md',
        resolve: {
          resources: ['$ocLazyLoad', 'ASSETS', function($ocLazyLoad, ASSETS) {
            return $ocLazyLoad.load([
              ASSETS.somsri.main.create_member_modal
            ]);
          }],
          options: function() {
            return options
          }
        }
      }).result.then(function (createdMember) {
        if(createdMember){
          ctrl.teachersRawData.push(createdMember) 
          var addingMember = formattingMemberData([createdMember])
          ctrl.membersAmount += addingMember.length
          $('#member-select-list').bootstrapTable('prepend', addingMember)
        }
      })
    }

  }]);
})();
