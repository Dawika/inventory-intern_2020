(function() {
    'use strict';
    angular.module('somsri.main.password_modal', [])
        .controller('passwordModalCtrl', ['$uibModalInstance', 'passwordModalService', 'translateFilter', function($uibModalInstance, service, translateFilter) {
            var ctrl = this;
            ctrl.isValid = true;
            ctrl.old_password = false;
            ctrl.message = "";


            ctrl.submit = function(parm) {
              if(parm != null){
                if (parm.password_confirmation != null && parm.new_password != null && parm.current_password != null) {
                    if (parm.current_password != null) {
                        service.get_old_password(parm.current_password).then(function(resp) {
                            ctrl.old_password = resp.data.password
                      if (ctrl.old_password && parm.password_confirmation == parm.new_password && (parm.new_password.length > 6 || parm.password_confirmation.length > 6) ) {
                        service.changePassword({
                            user: {
                                current_password: parm.current_password,
                                password: parm.new_password,
                                password_confirmation: parm.password_confirmation
                            }
                        }).then(function(res) {
                            $uibModalInstance.close(res);
                        });
                    } else if (parm.password_confirmation != parm.new_password) {
                        error_message(translateFilter('mismatch_warning'))
                    } else if (!ctrl.old_password) 
                        error_message(translateFilter('incorrect_password'))
                    } else if (parm.new_password.length < 6 || parm.password_confirmation.length < 6) {
                        error_message(translateFilter('invalid_password_length'))
                    }
                        })
                    }
                } else {
                   error_message(translateFilter('please_enter_your_password'))
                }
              } else {
                   error_message(translateFilter('please_enter_your_password'))
                }
            }

            function error_message(message) {
                ctrl.isValid = false;
                ctrl.message = message
            }

            ctrl.cancel = function() {
                $uibModalInstance.close();
            };

        }]);
})();
