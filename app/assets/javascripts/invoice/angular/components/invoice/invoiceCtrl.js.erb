(function() {
  'use strict';
  angular.module('somsri.invoice.invoice', [
  ])
  .controller('invoiceCtrl', ['$scope', '$http', 'DEFAULT_LOGO', 'LocalStorage', 'Currency', 'invoiceService', '$rootScope', 'translateFilter', '$stateParams', function($scope, $http, DEFAULT_LOGO, LocalStorage, Currency, service, $rootScope, translateFilter, $stateParams) {
    var ctrl = this;
    ctrl.id = $stateParams.id
    var defaultInvoice = {
      invoice: {
        items: [
          { detail: translateFilter('tuition_fee'), amount: 35000.0}
        ]
      }
    }

    $rootScope.loadAndAuthorizeResource("invoice", function(){
    $rootScope.menu = I18n.t('invoice_form');
      ctrl.title = 'Invoice';
       function isPaymentMethodMoreThanOne(){
         var count = 0;
         if(ctrl.datas.payment_method.is_cash){ count += 1; }
         if(ctrl.datas.payment_method.is_credit_card){ count += 1; }
         if(ctrl.datas.payment_method.is_cheque){ count += 1; }
         if(ctrl.datas.payment_method.is_transfer){ count += 1; }
         if(count > 1){
           return true;
         }else{
           return false;
         }
       }

      function initDatas(){
        if(!ctrl.datas) { ctrl.datas = {} }
        if(!ctrl.datas.student) { ctrl.datas.student = {} }
        ctrl.datas.parent = {};
      }

      function autoFillParent(parent_id){
        if(parent_id){
          for(var i = 0;i < ctrl.parent_info.length; i++){
            if(parent_id == ctrl.parent_info[i].id){
              initDatas();
              if(!ctrl.datas.parent.full_name){
                ctrl.datas.parent.full_name = ctrl.parent_info[i].full_name;
              }
            }
          }
        }
      }

      function autoFillStudent($item){
        if($item.student_id){        
          for(var i = 0;i < ctrl.student_info.length; i++){
            if($item.student_id == ctrl.student_info[i].id){
              initDatas();
              if(!ctrl.datas.student.full_name){
                ctrl.datas.student.full_name = ctrl.student_info[i].full_name;
              }
              if(!ctrl.datas.student.grade){
                ctrl.datas.student.grade = ctrl.student_info[i].grade
              }
              if(!ctrl.datas.student.student_number){
                ctrl.datas.student.student_number = ctrl.student_info[i].student_number;
                var sel = document.getElementById('grade');
                var opts = sel.options;
                for (var j = 0; j < opts.length; j++) {
                  if (opts[j].label == ctrl.student_info[i].grade) {
                    ctrl.datas.invoice.grade_name = opts[j].label
                  }
                }
              }
            }
          }
        }
      }

      ctrl.submitAmountModal = function(){
        var cash_amount = ctrl.datas.payment_method.cash_amount || 0;
        var credit_card_amount = ctrl.datas.payment_method.credit_card_amount || 0;
        var transfer_amount = ctrl.datas.payment_method.transfer_amount || 0;
        var cheque_amount = ctrl.datas.payment_method.cheque_amount || 0;
        ctrl.invoiceTotal();
        if(cash_amount + credit_card_amount + transfer_amount + cheque_amount != ctrl.total){
          $('#confirm-amount-modal').modal('show');
        }else{
          $('#amount-modal').on('hidden.bs.modal', function () {
            ctrl.createInvoice();
          });
          $('#amount-modal').modal('hide');
        }
      }

      ctrl.createInvoice = function(){
        $('#invoice button#submit').prop('disabled', true);
        service.createInvoice(ctrl.datas).then(function(resp) {
          // Reset Value
          ctrl.datas = defaultInvoice
          if($rootScope.openSlip(resp.data.id)) {
            window.location.reload();
          }
        },function(resp) {

        });
      }

      ctrl.onSelectParent = function ($item) {
        autoFillStudent($item);
        autoFillParent($item.id);
      };

      ctrl.onSelectStudentNumber = function ($item) {
        var sel = document.getElementById('grade');
        var opts = sel.options;
        for (var i = 0; i < opts.length; i++) {
          if (opts[i].label == $item.grade) {
            ctrl.datas.invoice.grade_name = opts[i].label
          }
        }
        ctrl.datas.student.full_name = $item.full_name;
        ctrl.datas.student.grade = $item.grade
        autoFillParent($item.parent_id);
      };

      ctrl.onSelectStudentFullName = function ($item) {
        var sel = document.getElementById('grade');
        var opts = sel.options;
        for (var i = 0; i < opts.length; i++) {
          if (opts[i].label == $item.grade) {
            ctrl.datas.invoice.grade_name = opts[i].label
          }
        }
        ctrl.datas.student.student_number = $item.student_number;
        ctrl.datas.student.grade = $item.grade
        autoFillParent($item.parent_id);
      };

      ctrl.onSelectLineItem = function ($item, $model) {
        $model.amount = $item.amount;
        ctrl.invoiceTotal();
      };

      // Adds an item to the invoice's items
      ctrl.addItem = function() {
        ctrl.datas.invoice.items.push({ amount:0, detail:"" });
        ctrl.invoiceTotal();
      }

      ctrl.cancel = function() {
      };

      ctrl.save = function() {
        if(isPaymentMethodMoreThanOne()){
          $('#amount-modal').modal('show');
        }else{
          ctrl.invoiceTotal();
          var pm = ctrl.datas.payment_method;
          if(pm.is_cash){
            pm.cash_amount = ctrl.total;
          }else if(pm.is_credit_card){
            pm.credit_card_amount = ctrl.total;
          }else if(pm.is_cheque){
            pm.cheque_amount = ctrl.total;
          }else if(pm.is_transfer){
            pm.transfer_amount = ctrl.total;
          }
          ctrl.createInvoice();
        }
      };

      // Remotes an item from the invoice
      ctrl.removeItem = function(item) {
        ctrl.datas.invoice.items.splice(ctrl.datas.invoice.items.indexOf(item), 1);
        ctrl.invoiceTotal();
      };

      // Calculates the sub total of the invoice
      ctrl.invoiceTotal = function() {
        var total = 0.00;
        angular.forEach(ctrl.datas.invoice.items, function(item, key){
          total += item.amount;
        });
        ctrl.total = total;
      };

      ctrl.validatePaymentMethod = function(){
        if (ctrl.datas) {
          var pm = ctrl.datas.payment_method;
          if(pm){
            return pm.is_cash || pm.is_credit_card || pm.is_cheque || pm.is_transfer;
          }else{
            return false;
          }
        }
      };

      (function init() {
        // Attempt to load invoice from local storage
        service.newInvoice().then(function(resp) {
          ctrl.invoice_number = resp.data.last_invoice_id + 1;
          ctrl.student_info = resp.data.student_info;
          ctrl.parent_info = resp.data.parent_info;
          ctrl.line_items_info = resp.data.line_items_info;
          ctrl.grades = resp.data.grades;

          var nowDate = new Date();
          // Clone to prevent the reset value
          ctrl.datas = defaultInvoice
          ctrl.datas.invoice.semester = resp.data.current_semester;
          ctrl.datas.payment_method = {};
          ctrl.datas.payment_method.is_cash = resp.data.default_cash_payment_method;
          ctrl.datas.payment_method.is_credit_card = resp.data.default_credit_card_payment_method;
          ctrl.datas.payment_method.is_transfer = resp.data.default_transfer_payment_method;
          ctrl.datas.payment_method.is_cheque = resp.data.default_cheque_payment_method;
          ctrl.datas.invoice.school_year = resp.data.school_year;

          ctrl.date_display = nowDate.getDate() + "/" + (nowDate.getMonth() + 1) + "/" + (nowDate.getFullYear() + 543);
          ctrl.availableCurrencies = Currency.all();
          ctrl.invoiceTotal();

          if(ctrl.id != null){
            service.getStudentInfo(ctrl.id).then(function(resp){
              if(!ctrl.datas) { ctrl.datas = {} }
              if(!ctrl.datas.student) { ctrl.datas.student = {} }
              ctrl.datas.parent = {};

              ctrl.datas.student.student_number = resp.data.student_number
              ctrl.datas.student.full_name = resp.data.full_name
              ctrl.datas.parent.full_name = resp.data.parent_name
              ctrl.datas.invoice.grade_name = resp.data.grade
            })
          }
        },function(resp) {
        });

      })()

      // Runs on document.ready
      angular.element(document).ready(function () {
        // Set focus
        document.getElementById('student_code').focus();
        $('.btn.btn-grades').find('option').first().remove();
      });
    });
  }]);
})();
