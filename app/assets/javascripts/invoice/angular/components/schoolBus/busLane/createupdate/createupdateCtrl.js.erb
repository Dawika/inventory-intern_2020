(function() {
  'use strict';
  angular.module('somsri.invoice.createbuslane', [
  ])
  .controller('createbuslaneCtrl', ['$scope', '$rootScope', 'buslaneService', '$stateParams',function($scope, $rootScope, service, $stateParams) {
    $rootScope.menu = I18n.t('bus_lane')
    var ctrl = this
    ctrl.studentInfo = []
    ctrl.employeeInfo = []
    ctrl.busInfo = []
    ctrl.haveStudent = false
    ctrl.studentSelect = []
    ctrl.id = $stateParams.id
    ctrl.datas = {
      name: '',
      note: '',
      bus: '',
      employee: '',
      students: ''
    }

    if(ctrl.id == null){
      service.getInfo().then(function(resp){
        ctrl.studentInfo = resp.data.students
        ctrl.employeeInfo = resp.data.employees
        ctrl.busInfo = resp.data.bus
      })
    }else{
       service.getBusLane(ctrl.id).then(function(resp){
        ctrl.datas.name = resp.data.name
        ctrl.datas.note = resp.data.note
        ctrl.datas.bus = resp.data.bus_lane
        ctrl.datas.employee = resp.data.employee
        ctrl.studentSelect = resp.data.students
        service.getInfo().then(function(resp){
          ctrl.studentInfo = resp.data.students
          ctrl.employeeInfo = resp.data.employees
          ctrl.busInfo = resp.data.bus
          ctrl.studentSelect.map(ctrl.clearStuentSelect)
        })
       })
    }

    ctrl.clearStuentSelect = function(students){
     for(var i = 0; i < ctrl.studentInfo.length ; i++){
        if(students.full_name == ctrl.studentInfo[i].full_name){
           ctrl.studentInfo.splice(i,1)
        }
      }
    }

    // add student
    ctrl.addStudent = function(students){
      for(var i = 0; i < ctrl.studentInfo.length ; i++){
        if(students != null){
          if(students.full_name == ctrl.studentInfo[i].full_name){
              ctrl.haveStudent = true
              ctrl.studentSelect.push({
              id: students.id,
              full_name: students.full_name,
              classroom: students.classroom
              })    
              ctrl.studentInfo.splice(i,1)
              ctrl.datas.students = ''
          }
        }
      } 
      ctrl.haveStudent ? true : $rootScope.opensuccessModal(I18n.t('not_student'), true), ctrl.haveStudent = false
    }
    
    // remove student
    ctrl.cancelStudent = function(student){
      for(var index = 0 ; index < ctrl.studentSelect.length ; index++){
         student.id == ctrl.studentSelect[index].id ? ( ctrl.haveStudent = false, ctrl.studentSelect.splice(index, 1), ctrl.studentInfo.push(student) ): false
      }
    }

    //delete
    ctrl.delete = function(){
      $rootScope.openConfirmationModal(I18n.t('confirm_delete_bus_lane'), true , function(){      
        service.deleteBusLane(ctrl.id).then(function(resp){
          resp.data.success ? ( $rootScope.openBusLane(), $rootScope.opensuccessModal(I18n.t('delete_success'), false) ) : false
        })
      })
    }

   // create and update
    ctrl.submit = function(data){
      if (ctrl.studentSelect == ''){
        $rootScope.opensuccessModal(I18n.t('please_add_student'), true)
        ctrl.haveStudent = false
        ctrl.datas.students = ''
      }else{
        if (ctrl.id == null){
          service.createBusLane(data, ctrl.studentSelect).then(function(resp){
            resp.data.success ? ( $rootScope.openBusLane(), $rootScope.opensuccessModal(I18n.t('save_success'), false) ) : false
          })
        }else{
          service.updateBusLane(ctrl.id, data, ctrl.studentSelect).then(function(resp){
            resp.data.success ? ( $rootScope.openBusLane(), $rootScope.opensuccessModal(I18n.t('save_success'), false) ) : false
          })
        }
      }
    }
  }]);
})();
