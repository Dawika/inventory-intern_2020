(function() {
  'use strict';
  angular.module('somsri.invoice.studentReport', [
  ])
  .controller('studentReportCtrl', ['$compile', '$scope', '$window', '$filter', '$rootScope', 'studentReportService', '$timeout', function($compile, $scope, $window, $filter, $rootScope, studentReportService, $timeout) {
    $rootScope.menu = "รายงาน"
    var ctrl = this
    $rootScope.loadAndAuthorizeResource("invoice", function(){
      ctrl.currentPage = 1;
      ctrl.grade_name = "All"
      ctrl.currentInvoiceStatus = null;
      ctrl.total = { other_fee: 0.0, amount: 0.0, tuition_fee: 0.0 }
      ctrl.invoiceFilter = [
        { text: "ทั้งหมด", value: "all" },
        { text: "ชำระแล้ว", value: "paid" },
        { text: "ยังไม่ได้ชำระ", value: "unpaid" }
      ]
      ctrl.invoiceFilterString = "ทั้งหมด"
      ctrl.pageChanged = function() {
        getStudents()
      };

      ctrl.switchGrade = function(grade_name) {
        ctrl.grade_name = grade_name
        getStudents();
      }

      ctrl.switchYear = function(year) {
        ctrl.currentYearString = year
        getStudents();
      }

      ctrl.switchSemester = function(semester) {
        ctrl.currentSemesterString = semester
        getStudents();
      }

      ctrl.invoiceStatusFilter = function(status) {
        ctrl.currentInvoiceStatus = status.value;
        ctrl.invoiceFilterString = status.text;
        getStudents();
      }

      function getStudents() {
        studentReportService.getGrades().then(function(grade_resp) {
          ctrl.currentGradeString = ctrl.grade_name
          ctrl.grades = grade_resp.data
          studentReportService.getStudents(ctrl.grade_name, ctrl.currentPage, ctrl.currentYearString, ctrl.currentSemesterString, ctrl.currentInvoiceStatus).then(function(resp) {
            ctrl.datas = [];
            if (resp.data && resp.data.datas){
              ctrl.datas = resp.data.datas
              ctrl.students = resp.data.datas
              ctrl.totalItems = resp.data.total_records
              ctrl.currentPage = resp.data.current_page
              ctrl.total.other_fee = resp.data.other_fee
              ctrl.total.tuition_fee = resp.data.tuition_fee
              ctrl.total.amount = resp.data.amount
            }
            ctrl.maxSize = 5;
          });
        });
      }

      function getYears() {
        studentReportService.getYears().then(function(resp) {
          ctrl.years = resp.data.all_years
          ctrl.currentYearString = resp.data.current_year
        });
      }

      function getSemesters() {
        studentReportService.getSemesters().then(function(resp) {
          ctrl.semesters = resp.data.semesters;
          ctrl.currentSemesterString = resp.data.current_semester;
          getStudents();
        });
      }

      getYears();
      getSemesters();

    });
  }]);
})();
