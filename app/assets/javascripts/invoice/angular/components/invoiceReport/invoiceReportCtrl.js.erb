(function() {
  'use strict';
  angular.module('somsri.invoice.invoice_report', [
  ])
  .controller('invoiceReportCtrl', ['$compile', '$scope', '$window', '$filter', '$rootScope', 'invoiceReportService', '$timeout', function($compile, $scope, $window, $filter, $rootScope, service, $timeout) {
    $rootScope.menu = "ใบเสร็จ"
    var ctrl = this

    $rootScope.loadAndAuthorizeResource("invoice", function(){
      ctrl.currentPage = 1;
      ctrl.searchKeyword = '';
      ctrl.grade_name = "All"
      ctrl.pageChanged = function() {
        getStudents()
      };

      ctrl.switchGrade = function(grade_name) {
        ctrl.grade_name = grade_name
        getStudents()
      }

      ctrl.search = function() {
        getStudents();
      }

      function getStudents() {
        if(!ctrl.currentPage){ ctrl.currentPage = 1 }
        service.getGrades().then(function(grade_resp) {
          ctrl.currentGradeString = ctrl.grade_name
          ctrl.grades = grade_resp.data
          service.getInvoices(ctrl.grade_name, ctrl.searchKeyword, ctrl.currentPage).then(function(resp) {
            ctrl.datas = [];
            if (resp.data && resp.data.invoices){
              ctrl.datas = resp.data.invoices
              ctrl.totalItems = resp.data.total_records;
              ctrl.currentPage = resp.data.current_page;
            } else {
              ctrl.totalItems = 0;
              ctrl.currentPage = 0;
            }
            ctrl.maxSize = 5;
          });
        });
      }

      ctrl.cancelInvoice = function() {
        service.cancelInvoice(ctrl.selectedInvoice.id).then(function(resp) {
          if(resp.data[0] == "SUCCESS"){
            ctrl.selectedInvoice.is_cancel = true;
            ctrl.selectedInvoice.status_name = "ยกเลิก";
            $('#cancelInvoiceModal').modal('hide');
          }
        });
      }

      ctrl.cancelInvoiceModal = function(invoice) {
        ctrl.selectedInvoice = invoice;
        $('#cancelInvoiceModal').modal('show');
      }

      ctrl.thisDay = function(date) {
        var today = new Date();
        var d = new Date(date);
        return today.toDateString()===d.toDateString();
      }

      getStudents();

    });

  }]);
})();
