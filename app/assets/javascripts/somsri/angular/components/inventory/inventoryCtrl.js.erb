(function() {
  'use strict';
  angular.module('somsri.somsri.inventory', [])
  .controller('inventoryCtrl', ['$compile', '$scope', '$window', '$filter', '$rootScope', '$timeout', 'translateFilter', '$uibModal', 'Upload', "inventoryService", function($compile, $scope, $window, $filter, $rootScope, $timeout, translateFilter, $uibModal, Upload, services) {
    $rootScope.menu = translateFilter("inventory")
    var ctrl = this
    var angularScopeRoot = 'angular.element(document.getElementById("angularCtrl")).scope().$root'
    var angularScopeInventory = 'angular.element(document.getElementById("angularCtrl")).scope().inventoryCtrl'
    var angularCtrlStr = "angular.element(document.getElementById('angularCtrl')).scope().inventory"
    // var alumni = "angular.element(document.getElementById('angularCtrl')).scope().alumni"
    ctrl.inventory = [];
    ctrl.message = '';
  $rootScope.loadAndAuthorizeResource("inventory", function(){
    var main_table = $('#inventory-table');
    ctrl.currentPage = 1;
    ctrl.sort = 'inventories.id';

    // default last 7 days
    ctrl.end_date = new Date();
    ctrl.start_date = new Date(new Date().setMonth(new Date().getMonth() - 1));
  

    function cleanDate(date){
      if(!date || new Date(date) == "Invalid Date"){return;}
      var nowDate = new Date()
      date.setHours(nowDate.getHours())
      date.setMinutes(nowDate.getMinutes())        
      date.setSeconds(nowDate.getSeconds())
      return date
    }

    function filterDate(value, row, index) {
      if (value) {
        return $filter('date')(value, 'dd/MM/yyyy');
      }
      return "-";
    }

    function translateCategory(value, row, index) {
      if (value) {
        return translateFilter(value)
      }
      return "-"
    }

    var bootstrapTableOptions = {
      onSort: function(item_name, order) {
        ctrl.sort = item_name;
        ctrl.order = order;
      },
      customSort: function(){},
      columns : [{
        field: 'id',
        title: '#',
        classes: 'text-right',
        sortable: true,
      },{
        field: 'item_name',
        title: translateFilter("item_name"),
        sortable: true,
      },{
        field: 'serial_number',
        title: translateFilter("serial_number"),
        sortable: true,
      },{
        field: 'model',
        title: translateFilter("model"),
        sortable: true,
      },{
        field: 'description',
        title: translateFilter("description"),
        sortable: true,
      },{
        field: 'price',
        title: translateFilter("price"),
        sortable: true,
      },{
        field: 'date_purchase',
        title: translateFilter("date_purchase"),
        sortable: true,
        formatter: filterDate
      },{
        field: 'category',
        title: translateFilter("category"),
        sortable: true,
        formatter: translateCategory
      },{
        field: 'date_add',
        title: translateFilter("date_add"),
        sortable: true,
        formatter: filterDate
      },{
        field: 'end_warranty',
        title: translateFilter("end_warranty"),
        sortable: true,
        formatter: filterDate
      },{
        field: 'edit',
        title: "",
        sortable: false,
        formatter : editInventoryFormatter
      },{
        field: 'delete',
        title: "",
        sortable: false,
        formatter : deleteInventoryFormatter
      }]
    }

    main_table.bootstrapTable($.extend(bootstrapTableOptions, {toolbar: "date-filter"}));
    
    function getInventory() {
      ctrl.start_date = cleanDate(ctrl.start_date)
      ctrl.end_date = cleanDate(ctrl.end_date)
      if(!ctrl.currentPage){ ctrl.currentPage = 1 }
        services.getInventory(ctrl.currentPage).then(function(resp) {
          ctrl.datasExport = [];
          if (resp.data) {
            ctrl.totalItems = resp.data.total_records;
            ctrl.currentPage = resp.data.current_page;
            ctrl.datasExport = resp.data.inventories
          } else {
            ctrl.totalItems = 0;
            ctrl.currentPage = 0;
          }
          ctrl.paginateButtonMaxSize = 5;
          main_table.bootstrapTable('load', ctrl.datasExport);
        });
    }

    ctrl.pageChanged = function() {
      getInventory()
    };

    function editInventoryFormatter(value, row, index) {
      return '<a id="editInventory' + row['id'] + '" onclick="' + angularCtrlStr + '.editInventory(' + row['id'] + ')"> <i class=\'fa fa-pencil-square-o fa-fw color-orange\'></i> </a>';
    }

    ctrl.editInventory = function(id) {
      $rootScope.updateInventory(id)
    }

    function deleteInventoryFormatter(value, row, index) {
      return '<a id="deleteInventory' + row['id'] + '" onclick="' + angularCtrlStr + '.deleteInventory(' + row['id'] + ')"> <i class=\'fa fa-trash color-red fa-fw\'></i></i> </a>';
    }

    ctrl.deleteInventory = function(id) {
      console.log(id)
        openConfirmationModal(translateFilter('delete_expense'), function(){
          services.removeInventory(id).then(function(resp) {
            getInventory()
            ctrl.message = translateFilter('inventory_delete_success')
            ctrl.typeSuccess = true
          }, function(e){
            ctrl.message = translateFilter('inventory_delete_failed')
            ctrl.typeSuccess = false
          })
        })
    }

    function openConfirmationModal(message, success, dismiss) {
      $scope.message = message;
      $uibModal.open({
        animation: true,
        backdrop: 'static',
        keyboard: false,
        scope: $scope,
        templateUrl: "<%= asset_path('somsri/angular/components/modal/confirm/confirmModalView.html') %>",
        controller: 'confirmModalCtrl as confirm',
        size: 'md',
        resolve: {
          resources: ['$ocLazyLoad', 'ASSETS', function($ocLazyLoad, ASSETS) {
            return $ocLazyLoad.load([
              ASSETS.somsri.somsri.confirm_modal
              ]);
          }]
        }
      }).result.then(function (result) {
        if (result) {
          if(success){ success() }
        }else{
          if(dismiss){ dismiss() }
        }
      });
    }

    ctrl.selectCategory = function(str) {
      console.log(str)
    }

    getInventory();

  });
  }]);
})();
