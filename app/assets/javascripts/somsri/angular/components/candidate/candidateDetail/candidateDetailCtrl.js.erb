(function() {
  'use strict';
    angular.module('somsri.somsri.candidate_detail', [])
    .controller('candidateDetailCtrl', ['$scope', '$rootScope', 'translateFilter',
    'candidateDetailService','$state',  '$uibModal', 'candidateService', '$window', 'candidateEditService',
    function($scope, $rootScope, translateFilter, candidateDetailService, $state,  $uibModal, service, $window, candidateEditService) {
      var ctrl = this;
      ctrl.showInterviewDate = false;
      ctrl.isValidDate = false;
      ctrl.submited;
      ctrl.notSubmited;
      ctrl.allSubmit
      
      $rootScope.menu = translateFilter('scout');
      candidateDetailService.getById($state.params.id).then(function(resp) {
        ctrl.datas = resp.data;
        ctrl.datas.candidate.interview.candidate_id = ctrl.datas.candidate.id;
        ctrl.datas.candidate.interview.interviewer_emails_attributes = ctrl.datas.candidate.interviewer_emails_attributes;
        
        if(ctrl.datas.candidate.shortlist){
          ctrl.buttonIcon = "fas fa-star color-yellow";
        }else{
          ctrl.buttonIcon = "far fa-star color-yellow";
        }
        
        
        if(ctrl.datas.candidate.interview.id != null){
          ctrl.showInterviewDate = true;
        }

        if( ctrl.datas.candidate.nick_name == null || ctrl.datas.candidate.nick_name == ''){
          ctrl.datas.candidate.full_name_and_nick_name = ctrl.datas.candidate.full_name
        }

        if(ctrl.datas.candidate.evaluate_is_submit){
          ctrl.submited = ctrl.datas.candidate.evaluate_is_submit;
          ctrl.notSubmited = ctrl.datas.candidate.evaluate_is_not_submit;
          ctrl.allSubmit = ctrl.submited.length + ctrl.notSubmited.length;
        }
      });
     
      ctrl.changStatus = function(check){
        if(check){
          ctrl.buttonIcon = "far fa-star color-yellow";
          ctrl.datas.candidate.shortlist = false;
        }
        else{
          ctrl.buttonIcon = "fas fa-star color-yellow";
          ctrl.datas.candidate.shortlist = true;
        }
        candidateDetailService.updateShortlist($state.params.id, ctrl.datas.candidate.shortlist).then(function(resp){

        });
      }
      
      ctrl.toEdit = function() {
        window.location.href = '/somsri#/candidate/' + ctrl.datas.candidate.id + '/edit';
      }

      ctrl.toConclusion = function(){
        window.location.href = '/somsri#/candidate/evaluate_conclusion/' + $state.params.id;
      }

    function openConfirmationModal(message, success, dismiss) {
      $scope.message = message;
      $uibModal.open({
        animation: true,
        backdrop: 'static',
        keyboard: false,
        scope: $scope,
        templateUrl: "<%= asset_path('somsri/angular/components/modal/minimalConfirmModal/minimalConfirmModalView.html') %>",
        controller: 'minimalConfirmModalCtrl as confirm',
        size: 'md',
        resolve: {
          resources: ['$ocLazyLoad', 'ASSETS', function($ocLazyLoad, ASSETS) {
            return $ocLazyLoad.load([
              ASSETS.somsri.somsri.minimal_confirm_modal
            ]);
          }]
        }
      }).result.then(function (isConfirm) {
        if (isConfirm) {
          if(success){ success() }
        }else{
          if(dismiss){ dismiss() }
        }
      });
    }
  

    ctrl.removeCandidate = function(id){
      openConfirmationModal(translateFilter('confirmdelete'), function(){
        service.removeCandidate(id).then(function(resp) {
           window.location.href = "/somsri#/candidate";
        });
      })
    } 

    function displayFlashMessage(message, typeSuccess){
      ctrl.timeout = false
      ctrl.message = message;
      ctrl.typeSuccess = typeSuccess;
      $window.scrollTo(0, 0);
      $timeout( function(){
        ctrl.timeout = true
      }, 5000);
    }

    ctrl.back = function(){
      window.location.href = '/somsri#/candidate';
    }

    ctrl.openInterviewModal = function(){
      if(!ctrl.datas.candidate.evaluate){
        $scope.candidate_id = ctrl.datas.candidate.id
        $uibModal.open({
          animation: true,
          backdrop: 'static',
          keyboard: false,
          scope: $scope,
          templateUrl: "<%= asset_path('somsri/angular/components/candidate/candidateDetail/interviewModal/interviewModalView.html') %>",
          controller: 'interviewModalCtrl as interviewModal',
          size: 'md',
          resolve: {
            resources: ['$ocLazyLoad', 'ASSETS', function($ocLazyLoad, ASSETS) {
              return $ocLazyLoad.load([
                ASSETS.somsri.somsri.interview_modal
              ]);
            }]
          }
        }).result.then(function (resp) {
          if (resp) {
            ctrl.showInterviewDate = true;
            ctrl.datas.candidate.interview = resp;
          }
        });
      }
    }

    ctrl.openSentEmailModal = function(){
      $scope.candidate_id = ctrl.datas.candidate.id
      $uibModal.open({
        animation: true,
        backdrop: 'static',
        keyboard: false,
        scope: $scope,
        templateUrl: "<%= asset_path('somsri/angular/components/candidate/candidateDetail/sentEmailModal/sentEmailModalView.html') %>",
        controller: 'sentEmailModalCtrl as sentEmailModal',
        size: 'md',
        resolve: {
          resources: ['$ocLazyLoad', 'ASSETS', function($ocLazyLoad, ASSETS) {
            return $ocLazyLoad.load([
              ASSETS.somsri.somsri.sent_email_modal
            ]);
          }]
        }
      }).result.then(function (resp) {
        if (resp) {
          ctrl.datas.candidate.evaluate = resp.result.evaluate
          ctrl.submited = resp.result.evaluate_is_submit;
          ctrl.notSubmited = resp.result.evaluate_is_not_submit;
          ctrl.allSubmit = ctrl.submited.length + ctrl.notSubmited.length;
        }
      });
      
    }


  }]);
})();