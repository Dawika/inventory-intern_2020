(function() {
  'use strict';
  angular.module('somsri.somsri.interview_modal', [
  ])
  .controller('interviewModalCtrl', ['$scope', '$rootScope', '$uibModalInstance', 'interviewModalService', '$uibModal', 'translateFilter',
  function($scope, $rootScope, $uibModalInstance, interviewModalService, $uibModal, translateFilter) {

    var ctrl = this;
    ctrl.categorys = ['ฝึกงาน', 'สหกิจ', 'สมัครงาน']
    ctrl.listHours = ['00', '01', '02', '03', '04', '05', '06','07', '08', '09',
    '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '20', '21', '22', '23']
    ctrl.listMinutes = ['00','05', '10', '15', '20', '25', '30', '35', '40', '45', '50', '55']
    ctrl.minute = '00';
    ctrl.hour = '00';
    ctrl.candidate_id = $scope.candidate_id;
    ctrl.datas;

    $rootScope.loadAndAuthorizeResource("interview", function() {
      loadInterview()

    });

    function loadInterview() {
      interviewModalService.getInterview(ctrl.candidate_id).then(function(resp) {
        
        ctrl.datas = resp.data;
        ctrl.datas.candidate.interview.candidate_id = ctrl.datas.candidate.id;
        ctrl.datas.candidate.interview.interviewer_emails_attributes = ctrl.datas.candidate.interviewer_emails_attributes;
        ctrl.category = ctrl.datas.candidate.interview.category;
        ctrl.location = ctrl.datas.candidate.interview.location;
        newDateType()
        ctrl.date = ctrl.datas.candidate.interview.date;
        ctrl.interviewer_emails_attributes = ctrl.datas.candidate.interview.interviewer_emails_attributes

        
      });
    }

    ctrl.close = function () {
      $uibModalInstance.close();
      
    };

    ctrl.openDatePopup = function() {
      ctrl.datePopup.opened = true;
    };

    ctrl.datePopup = {
      opened: false
    };

    function newDateType(){
      if (ctrl.datas.candidate.interview.date != null) {
        ctrl.datas.candidate.interview.date = new Date(ctrl.datas.candidate.interview.date)
        var hour = ctrl.datas.candidate.interview.date.getHours();
        ctrl.hour = hour < 10 ? "0" + hour : "" + hour;
        var minute = ctrl.datas.candidate.interview.date.getMinutes()
        ctrl.minute = minute < 10 ? '0' + minute : "" + minute;
      } else {
        ctrl.datas.candidate.interview.date = null
      }
    }

    ctrl.addMoreEmail = function(){
      ctrl.interviewer_emails_attributes.push({ id: "", email: "" });
    }

    ctrl.removeInterViewEmail = function(index) {
      ctrl.interviewer_emails_attributes[index]._destroy = true
    }

    ctrl.saveInterview = function() {
  
      ctrl.date.setHours(ctrl.hour,ctrl.minute)
      ctrl.datas.candidate.interview.date = ctrl.date;
      ctrl.datas.candidate.interview.category = ctrl.category;
      ctrl.datas.candidate.interview.location = ctrl.location;
      ctrl.datas.candidate.interview.interviewer_emails_attributes = ctrl.interviewer_emails_attributes;
      console.log(ctrl.datas.candidate.interview)

      interviewModalService.saveInterview(ctrl.datas.candidate.interview).then(function(resp) {
        ctrl.datas = resp.data;
        $uibModalInstance.close(ctrl.datas.candidate.interview);
      });

    }
    ctrl.save = function(){
      openConfirmationModal(translateFilter('close_with_save'), function(){
        ctrl.saveInterview();
      })
    }
    ctrl.checkSave = function(){

      if(ctrl.hour == "" || ctrl.minute == "" || ctrl.date == null){
        return true
      }else{
        return false
      }
     

    }
    
    function openConfirmationModal(message, success, dismiss) {
      $scope.message = message;
      $uibModal.open({
        animation: true,
        backdrop: 'static',
        keyboard: false,
        scope: $scope,
        templateUrl: "<%= asset_path('somsri/angular/components/modal/minimalConfirmSave/minimalConfirmSaveView.html') %>",
        controller: 'minimalConfirmSaveModalCtrl as confirm',
        size: 'md',
        resolve: {
          resources: ['$ocLazyLoad', 'ASSETS', function($ocLazyLoad, ASSETS) {
            return $ocLazyLoad.load([
              ASSETS.somsri.somsri.minimal_confirm_save_modal
            ]);
          }]
        }
      }).result.then(function (isConfirm) {
        if (isConfirm) {
          if(success){ success() }
        }else{
          if(dismiss){ dismiss() }
        }
      });
    }
  }]);
})();