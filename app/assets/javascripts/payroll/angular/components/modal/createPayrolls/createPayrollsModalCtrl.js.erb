(function() {
  'use strict';
  angular.module('somsri.payroll.create_payrolls_modal', [
  ])
  .controller('createPayrollsModalCtrl', ['$uibModalInstance', '$state', '$log', 'createPayrollsModalService', '$rootScope', function($uibModalInstance, $state, $log, service, $rootScope) {
    var ctrl = this;
    $rootScope.loadAndAuthorizeResource("payroll", function(){

      ctrl.submit = function(){
        var params = { create: { effective_date: ctrl.effective_date }, option: {force_create: false} };
        service.createPayrolls(params).then(function(res) {
          if(res.data["error"] == "PAYROLLS_EXIST"){
            var message = "มีรายการ payroll ในวันนี้อยู่แล้ว ท่านต้องการจะสร้างรายการใหม่และลบรายการเดิมหรือไม่"
            $rootScope.openConfirmationModal(message, function(res) {
              params["option"]["force_create"] = true;
              service.createPayrolls(params).then(function(res) {
                $uibModalInstance.close(params["create"]["effective_date"]);
              }, function(res) {
                console.log("ERROR");
              })
            }, function(res) {
              console.log("DISMISS CONFIRM");
            })
          }else{
            $uibModalInstance.close(params["create"]["effective_date"]);
          }
        },function(res) {
          console.log("ERROR");
        });
      }

      ctrl.cancel = function () {
        $uibModalInstance.close(false);
      };

      ctrl.openEffectiveDatePopup = function() {
        ctrl.effectiveDatePopup.opened = true;
      };

      ctrl.effectiveDatePopup = {
        opened: false
      };
    });
  }]);
})();
